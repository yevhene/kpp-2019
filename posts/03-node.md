# 3. Основи Node.js

## Середа виконання JavaScript

### Рушій
Рушій (engine) - це програма (або набір програм) що відповідає за компіляцію та виконання програмного (в тому числі JavaScript) коду.
Існує велика кількість різноманітних рушіїв JavaScript. Більшість із низ з'явились під конкретні браузери:
- Mozilla Firefox - Rhino, SpiderMonkey
- Google Chrome - V8
- Konqueror - KJS
- Internet Explorer - Chakra
Але є і незалежні:
- Narcissus — рушій JavaScript з відкритим вихідним кодом, написаний Бренданом Айхом
- Tamarin — рушій JavaScript від компанії Adobe Systems

### Оточення
Оточення (execution environment, runtime) - це рушій для виконання та сукупність програмних інтерфейсів (API) доступних програмам на JavaScript.
Оточення розрізняються своїм призначенням:
- Браузерні
- Загального призначення - node.js
- Настільні - Electron
- Headless - PhantomJS

## Node.js
**Node.js** - це JavaScript–оточення побудоване на JavaScript–рушієві V8 (що розроблявся для браузера Google Chrome).
Node.js використовує подієву, неблокуючу I/O модель, що робить його легким та ефективним. Пакетна екосистема Node.js, npm, є найбільшою у світі екосистемою бібліотек з відкритим кодом.

Особливістю JavaScript є подієва модель - більшість "важких" операцій у JavaScript відбувається асинхронно, за рахунок очікування на відповідь вводу-виводу (IO) та передачі контролю бібліотекам скомпільованим в машинний код. Тобто зазвичай спочатку ініціюється операція, програма підписується на подію "виконання операції" і переходить в режим очікування. Підписка на події відбувається зазвичай за допомогою зворотніх викликів (callbacks).

### Цикл подій
Керує процесом асинхронного виконання коду **цикл подій** (event loop):
![Event Loop](event-loop.png)

- **timers** - спрацьовують setTimeout і setInterval
- **I/O callbacks** - зворотні виклики пов'язані з вводом-виводом
- **idle, prepare** - внутрішні
- **poll** - опитування нових подій
- **check** - спрацьовують setImmediate
- **close callbacks** - спрацьовують закриття з'єднань

### Hello World
*app.js*
```
console.log('Hello World');
```

Запуск
```
node app.js
```

### Модульна система
Модульна система Node.js відповідає стандарту CommonJS.
Для імпортування залежностей використовується функція `require`. Якщо імпортується пакет, вказується назва пакету. В результаті імпортується файл `index.js` з пакета (за замовчуванням, можна змінити в `package.json`, вказавши `main`).

```
const path = require('path');
```

Для того щоб імпортувати JavaScript-файл необхадно вказати відносний шлях до файла (навіть якщо файл лежить в тій самій папці, необхідно додати `./`).
```
const math = require('./math');
```

### Вбудовані пакети
Оскільки JavaScript створювався, як мова що буде вбудована в браузер, пакети що роблять його мовою загального призначення постачаються разом з node.js. Це модулі для роботи з файловою системою (path, fs), з терміналом (readline), з мережею (http) та інші.

Деякі функції вбодованих модулів мають синхронну та асинхронну версії.
Синхронна:
```javascript
const fs = require('fs');

const content = fs.readFileSync('app.js', 'utf8');

console.log(content);
```

Асинхронна:
```javascript
const fs = require('fs');

fs.readFile('app.js', 'utf8', function(err, content) {
  if (err) {
    console.log(err);
  } else {
    console.log(content);
  }
});
```
Оскільки JavaScript має подієву модель, рекомендується використовувати асинхронні версії.
Асинхронні версії функцій зазвичай приймають функцію, що називаються *зворотним викликом*. Зазвичай ця функція приймає два або більше аргументів. Перший аргумент зазвичай відповідає за помилку. Інші - за результати успішного виконання функції.

